<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Partnership Matchup Ratings</title>
  <style>
    :root{
      --bg:#f6f3ed;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 30px rgba(17,24,39,0.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink);}
    header{padding:22px 16px 10px; text-align:center;}
    h1{margin:0; font-size:1.65rem; letter-spacing:-0.02em;}
    .sub{margin:6px 0 0; color:var(--muted); font-size:0.95rem;}
    .wrap{max-width:1200px; margin:0 auto; padding:12px 14px 42px;}
    .grid{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media(min-width: 980px){ .grid{grid-template-columns: 460px 1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end;}
    label{display:block; font-size:0.82rem; color:var(--muted); margin:0 0 6px;}
    select,input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      font-size:0.95rem;
      outline:none;
    }
    input[type="number"]{padding-right:8px;}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      width:100%;
    }
    .btn.secondary{background:#fff; color:var(--ink);}
    .btn:disabled{opacity:0.55; cursor:not-allowed;}
    .hint{font-size:0.86rem; color:var(--muted); margin-top:10px; line-height:1.35;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .pill{display:inline-block; padding:4px 8px; border:1px solid var(--line); border-radius:999px; font-size:0.78rem; color:var(--muted);}

    .sectionTitle{
      display:flex; justify-content:space-between; align-items:baseline; gap:10px; flex-wrap:wrap;
      margin:4px 0 10px;
    }
    .sectionTitle .k{font-weight:900; letter-spacing:-0.01em}
    .sectionTitle .m{color:var(--muted); font-size:0.85rem}

    .tileWrap{display:grid; grid-template-columns: 1fr; gap:10px;}
    @media(min-width: 980px){ .tileWrap{grid-template-columns: 1fr 1fr;} }

    .panel{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:linear-gradient(180deg,#fff,#fcfcfc);
    }
    .panelHead{display:flex; justify-content:space-between; align-items:baseline; gap:10px; flex-wrap:wrap; margin-bottom:10px;}
    .panelHead .name{font-weight:950; font-size:1.02rem;}
    .panelHead .meta{color:var(--muted); font-size:0.82rem;}

    .tiles{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    /* Stronger heat */
    .tile{
      border:1px solid rgba(17,24,39,0.10);
      border-radius:16px;
      padding:10px 10px;
      position:relative;
      overflow:hidden;
      min-height:88px;
      box-shadow: 0 6px 18px rgba(17,24,39,0.06);
      background: rgba(255,255,255,0.65);
    }
    .tile::before{
      content:"";
      position:absolute; inset:0;
      background: var(--heat, rgba(229,231,235,0.9));
      opacity: 0.92;
    }
    .tile::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(130px 90px at 20% 10%, rgba(255,255,255,0.55), rgba(255,255,255,0));
      opacity:0.9;
      pointer-events:none;
    }
    .tile .top{
      position:relative;
      display:flex; justify-content:space-between; align-items:baseline; gap:10px;
      margin-bottom:6px;
    }
    .tile .bt{font-weight:950;}
    .tile .tag{
      font-size:0.78rem;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.55);
      background: rgba(255,255,255,0.25);
      color: rgba(17,24,39,0.88);
    }
    .tile .val{
      position:relative;
      font-size:2.0rem;
      font-weight:1000;
      letter-spacing:-0.03em;
      line-height:1.0;
      color: rgba(17,24,39,0.95);
    }
    .tile .sub{
      position:relative;
      margin-top:4px;
      color: rgba(17,24,39,0.72);
      font-size:0.86rem;
    }

    .kpis{
      display:grid; gap:10px;
      grid-template-columns: 1fr;
      margin-top:10px;
    }
    @media(min-width: 560px){ .kpis{grid-template-columns: 1fr 1fr;} }
    .kpi{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      position:relative;
      overflow:hidden;
      box-shadow: 0 8px 22px rgba(17,24,39,0.06);
      min-height:88px;
      background:#fff;
    }
    .kpi::before{
      content:"";
      position:absolute; inset:0;
      background: var(--heat, rgba(229,231,235,0.9));
      opacity: 0.92;
    }
    .kpi .t{position:relative; font-size:0.78rem; color: rgba(17,24,39,0.74); text-transform:uppercase; letter-spacing:0.10em;}
    .kpi .v{position:relative; font-size:2.2rem; font-weight:1000; margin-top:6px; letter-spacing:-0.03em;}
    .kpi .s{position:relative; font-size:0.85rem; color: rgba(17,24,39,0.72); margin-top:4px;}

    .weights{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      margin-top:10px;
    }
    .weights table{width:100%; border-collapse:collapse; font-size:0.92rem;}
    .weights th,.weights td{padding:10px 10px; border-bottom:1px solid var(--line); text-align:right;}
    .weights th:first-child,.weights td:first-child{text-align:left;}
    .weights thead th{font-size:0.78rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); background:#fafafa;}
    .weights input{padding:8px 8px; border-radius:10px;}

    .err{color:#b91c1c; font-weight:850;}
    .ok{color:#065f46; font-weight:850;}
    .legend{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; color:var(--muted); font-size:0.85rem;}
    .sw{width:14px; height:14px; border-radius:6px; border:1px solid rgba(17,24,39,0.12); display:inline-block;}
    .searchBox{display:flex; gap:8px; align-items:center; margin-top:8px;}
    .searchBox input{flex:1 1 auto;}
    .small{font-size:0.85rem; color:var(--muted);}
  </style>
</head>
<body>
<header>
  <h1>Partnership Matchup Ratings</h1>
  <div class="sub">Choose a metric → see z-scores by bowl type for each batter and the partnership.</div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Controls -->
    <div class="card">
      <div class="row">
        <div style="flex:1 1 200px; min-width:200px;">
          <label for="searchA">Search Batter 1</label>
          <input id="searchA" placeholder="Type to filter…" />
          <div class="small">Dropdown updates as you type.</div>
          <div style="height:8px"></div>
          <label for="batA">Batter 1</label>
          <select id="batA"></select>
        </div>

        <div style="flex:1 1 200px; min-width:200px;">
          <label for="searchB">Search Batter 2</label>
          <input id="searchB" placeholder="Type to filter…" />
          <div class="small">Dropdown updates as you type.</div>
          <div style="height:8px"></div>
          <label for="batB">Batter 2</label>
          <select id="batB"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1 1 150px; max-width:220px;">
          <label for="metric">Metric</label>
          <select id="metric">
            <option value="run">Run impact (higher z = better)</option>
            <option value="wicket">Wicket impact (lower z = better)</option>
            <option value="total">Total impact (lower z = better)</option>
          </select>
        </div>

        <div style="flex:1 1 120px; max-width:190px;">
          <label for="alpha">alpha</label>
          <input id="alpha" type="number" min="0" max="1" step="0.01" value="0.67" />
        </div>

        <div style="flex:1 1 170px; max-width:260px;">
          <label for="weightPreset">Weights</label>
          <select id="weightPreset">
            <option value="default">Load from weights.json</option>
            <option value="equal">Equal weights</option>
            <option value="custom">Custom (edit below)</option>
          </select>
        </div>

        <div style="flex:1 1 120px; max-width:190px;">
          <label>&nbsp;</label>
          <button id="calcBtn" class="btn">Recalculate</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px; align-items:center;">
        <label style="margin:0; display:flex; gap:8px; align-items:center; color:var(--muted); font-size:0.88rem;">
          <input id="normalizeWeights" type="checkbox" checked />
          Normalize custom weights to sum = 1
        </label>
        <div class="pill mono" id="weightSum">sum: —</div>
      </div>

      <div id="status" class="hint"></div>

      <div class="weights" id="weightsBox" style="display:none;">
        <table>
          <thead>
            <tr><th>Bowl type</th><th>Weight</th></tr>
          </thead>
          <tbody id="weightsBody"></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="copyWeights" class="btn secondary">Copy weights JSON</button>
        <button id="resetWeights" class="btn secondary">Reset to file</button>
      </div>

      <div class="hint">
        <div class="pill mono">run_pair = α·max(A_run,B_run) + (1-α)·min(A_run,B_run)</div>
        <div style="height:8px"></div>
        <div class="pill mono">wicket_pair = α·min(A_wk,B_wk) + (1-α)·max(A_wk,B_wk)</div>
        <div style="height:8px"></div>
        <div>Tile colors are based on “better-ness” for the selected metric (run: higher is greener; wicket/total: lower is greener).</div>
      </div>

      <div class="legend">
        <span class="sw" style="background: rgb(220,38,38); opacity:0.85;"></span> worse
        <span class="sw" style="background: rgb(245,158,11); opacity:0.85;"></span> mid
        <span class="sw" style="background: rgb(34,197,94); opacity:0.85;"></span> better
      </div>
    </div>

    <!-- Tiles + Output -->
    <div class="card">
      <div class="sectionTitle">
        <div class="k">Z-scores by bowl type</div>
        <div class="m" id="metaRight">—</div>
      </div>

      <div class="tileWrap">
        <div class="panel">
          <div class="panelHead">
            <div class="name" id="nameA">Batter 1</div>
            <div class="meta" id="metaA">—</div>
          </div>
          <div class="tiles" id="tilesA"></div>
        </div>

        <div class="panel">
          <div class="panelHead">
            <div class="name" id="nameB">Batter 2</div>
            <div class="meta" id="metaB">—</div>
          </div>
          <div class="tiles" id="tilesB"></div>
        </div>

        <div class="panel" style="grid-column: 1 / -1;">
          <div class="panelHead">
            <div class="name" id="nameP">Partnership</div>
            <div class="meta" id="metaP">—</div>
          </div>
          <div class="tiles" id="tilesP"></div>
        </div>
      </div>

      <div class="sectionTitle" style="margin-top:14px;">
        <div class="k">Final compatibility</div>
        <div class="m mono" id="pairTitle">—</div>
      </div>

      <div class="kpis">
        <div class="kpi" id="finalBox" style="--heat: rgb(245,158,11);">
          <div class="t" id="finalLabel">Final score (weighted z)</div>
          <div class="v" id="finalScore">—</div>
          <div class="s" id="finalSub">Σ w × z (direction-adjusted)</div>
        </div>
        <div class="kpi" style="--heat: rgba(255,255,255,0.0); border-style:dashed;">
          <div class="t">Note</div>
          <div class="s" style="margin-top:8px; line-height:1.35;">
            For wicket/total, “better” means <b>lower</b>, so we invert z internally for coloring and the final score.
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/**
 * JSON files expected in the SAME folder as index.html:
 *  - run_pivot.json
 *  - wicket_pivot.json
 *  - balls_pivot.json (optional)
 *  - baseline.json
 *  - weights.json
 */
let RUN=null, WK=null, BALLS=null, BASE=null, FILE_WEIGHTS=null;
let customWeights = null;
let ALL_BATS = [];

const $ = (id)=>document.getElementById(id);

function clamp(v, lo, hi){ return Math.min(hi, Math.max(lo, v)); }
function fmt(x, d=2){
  if(x===null || x===undefined || Number.isNaN(x)) return "—";
  const n = Number(x);
  if(!Number.isFinite(n)) return "—";
  return n.toFixed(d);
}
async function loadJSON(url){
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error(`Failed to load ${url} (${res.status})`);
  return await res.json();
}
function setStatus(msg, kind=""){
  const el=$("status");
  el.innerHTML = kind ? `<span class="${kind}">${msg}</span>` : msg;
}
function zscore(x, mean, std){
  const s = (std && std!==0) ? std : 1;
  return (x - mean) / s;
}

/* --- color mapping based on "goodness z" --- */
function heatFromGoodZ(gz){
  if(!Number.isFinite(gz)) return "rgba(229,231,235,0.9)";
  const z = clamp(gz, -2.5, 2.5);

  const red   = [220, 38, 38];
  const amber = [245,158, 11];
  const green = [ 34,197, 94];

  function lerp(a,b,t){ return a + (b-a)*t; }
  function mix(c1,c2,t){
    const rr = Math.round(lerp(c1[0],c2[0],t));
    const gg = Math.round(lerp(c1[1],c2[1],t));
    const bb = Math.round(lerp(c1[2],c2[2],t));
    return `rgb(${rr},${gg},${bb})`;
  }

  if(z < 0){
    const t = (z + 2.5) / 2.5; // -2.5->0, 0->1
    return mix(red, amber, t);
  } else {
    const t = z / 2.5; // 0->0, 2.5->1
    return mix(amber, green, t);
  }
}

function getVal(pivot, bat, bt){
  const v = pivot?.values?.[bat]?.[bt];
  return (v===null || v===undefined || Number.isNaN(v)) ? 0 : Number(v);
}

function normalizeWeights(w, bowlTypes){
  const out = {};
  let sum = 0;
  bowlTypes.forEach(bt=>{
    const val = Number(w?.[bt] ?? 0);
    out[bt] = Number.isFinite(val) ? val : 0;
    sum += out[bt];
  });
  if(sum <= 0) return { w: out, sum: 0 };
  bowlTypes.forEach(bt => out[bt] = out[bt] / sum);
  return { w: out, sum: 1 };
}

function currentWeights(bowlTypes){
  const preset = $("weightPreset").value;
  if(preset === "equal"){
    const val = 1.0 / bowlTypes.length;
    const w = {}; bowlTypes.forEach(bt => w[bt]=val);
    return { w, sum: 1 };
  }
  if(preset === "custom"){
    const w0 = customWeights || {};
    if($("normalizeWeights").checked){
      return normalizeWeights(w0, bowlTypes);
    }
    const w = {};
    let sum = 0;
    bowlTypes.forEach(bt=>{
      const val = Number(w0?.[bt] ?? 0);
      w[bt] = Number.isFinite(val) ? val : 0;
      sum += w[bt];
    });
    return { w, sum };
  }
  const w0 = FILE_WEIGHTS || {};
  const w = {};
  let sum = 0;
  bowlTypes.forEach(bt=>{
    const val = Number(w0?.[bt] ?? 0);
    w[bt] = Number.isFinite(val) ? val : 0;
    sum += w[bt];
  });
  return { w, sum };
}

/* --- z for each entity --- */
function computeBatterZ(bat, bt, metric){
  const run = getVal(RUN, bat, bt);
  const wk  = getVal(WK,  bat, bt);
  const tot = run + wk;
  const b = BASE?.[bt] || null;
  if(!b) return NaN;

  if(metric === "run") return zscore(run, b.run_mean, b.run_std);
  if(metric === "wicket") return zscore(wk, b.wk_mean, b.wk_std);
  return zscore(tot, b.total_mean, b.total_std);
}

function computePartnershipZ(batA, batB, bt, metric, alpha){
  const A_run = getVal(RUN, batA, bt);
  const B_run = getVal(RUN, batB, bt);
  const A_wk  = getVal(WK,  batA, bt);
  const B_wk  = getVal(WK,  batB, bt);

  const run_pair = alpha * Math.max(A_run, B_run) + (1-alpha) * Math.min(A_run, B_run);
  const wk_pair  = alpha * Math.min(A_wk, B_wk)  + (1-alpha) * Math.max(A_wk, B_wk);
  const tot_pair = run_pair + wk_pair;

  const b = BASE?.[bt] || null;
  if(!b) return NaN;

  if(metric === "run") return zscore(run_pair, b.run_mean, b.run_std);
  if(metric === "wicket") return zscore(wk_pair, b.wk_mean, b.wk_std);
  return zscore(tot_pair, b.total_mean, b.total_std);
}

// for coloring + final score: run higher better; wicket/total lower better => invert
function goodnessZ(z, metric){
  if(!Number.isFinite(z)) return NaN;
  return (metric === "run") ? z : -z;
}

function buildTile(bt, metricLabel, z, metric){
  const div = document.createElement("div");
  div.className = "tile";
  const gz = goodnessZ(z, metric);
  div.style.setProperty("--heat", heatFromGoodZ(gz));
  div.innerHTML = `
    <div class="top">
      <div class="bt mono">${bt}</div>
      <div class="tag">${metricLabel}</div>
    </div>
    <div class="val">${fmt(z, 2)}</div>
    <div class="sub">z-score</div>
  `;
  return div;
}

function renderBatterTiles(containerId, batName, metric){
  const el = $(containerId);
  el.innerHTML = "";
  const bowlTypes = RUN.bowl_types;
  const label = (metric === "run") ? "RUN" : (metric === "wicket") ? "WICKET" : "TOTAL";
  bowlTypes.forEach(bt=>{
    const z = computeBatterZ(batName, bt, metric);
    el.appendChild(buildTile(bt, label, z, metric));
  });
}

function renderPartnershipTiles(containerId, batA, batB, metric, alpha){
  const el = $(containerId);
  el.innerHTML = "";
  const bowlTypes = RUN.bowl_types;
  const label = (metric === "run") ? "RUN" : (metric === "wicket") ? "WICKET" : "TOTAL";
  bowlTypes.forEach(bt=>{
    const z = computePartnershipZ(batA, batB, bt, metric, alpha);
    el.appendChild(buildTile(bt, label, z, metric));
  });
}

function computeFinalWeightedGoodZ(batA, batB, metric, alpha, weights){
  const bowlTypes = RUN.bowl_types;
  let sum = 0;
  let wsum = 0;

  bowlTypes.forEach(bt=>{
    const z = computePartnershipZ(batA, batB, bt, metric, alpha);
    const gz = goodnessZ(z, metric);
    const w = Number(weights?.[bt] ?? 0);
    if(!Number.isFinite(gz) || !Number.isFinite(w) || w <= 0) return;
    sum += w * gz;
    wsum += w;
  });

  if(wsum <= 0) return NaN;
  return sum / wsum;
}

/* --- weights editor --- */
function renderWeightsEditor(bowlTypes){
  const body = $("weightsBody");
  body.innerHTML = "";

  if(!customWeights){
    try{
      const saved = localStorage.getItem("pm_custom_weights");
      if(saved) customWeights = JSON.parse(saved);
    }catch(e){}
    if(!customWeights) customWeights = {};
  }

  bowlTypes.forEach(bt=>{
    if(customWeights[bt]===undefined){
      customWeights[bt] = Number(FILE_WEIGHTS?.[bt] ?? (1/bowlTypes.length));
    }
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${bt}</td>
      <td style="width:160px;">
        <input class="wIn" data-bt="${bt}" type="number" step="0.001" value="${customWeights[bt]}" />
      </td>
    `;
    body.appendChild(tr);
  });

  [...document.querySelectorAll(".wIn")].forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const bt = inp.getAttribute("data-bt");
      const v = Number(inp.value);
      customWeights[bt] = Number.isFinite(v) ? v : 0;
      try{ localStorage.setItem("pm_custom_weights", JSON.stringify(customWeights)); }catch(e){}
      calc();
    });
  });

  $("weightsBox").style.display = "block";
}

async function copyWeightsJSON(){
  const bowlTypes = RUN.bowl_types;
  const { w } = currentWeights(bowlTypes);
  const txt = JSON.stringify(w, null, 2);
  try{
    await navigator.clipboard.writeText(txt);
    setStatus("Copied weights JSON to clipboard.", "ok");
  }catch(e){
    window.prompt("Copy weights JSON:", txt);
  }
}

function resetWeightsToFile(){
  customWeights = JSON.parse(JSON.stringify(FILE_WEIGHTS || {}));
  try{ localStorage.setItem("pm_custom_weights", JSON.stringify(customWeights)); }catch(e){}
  renderWeightsEditor(RUN.bowl_types);
  $("weightPreset").value = "custom";
  calc();
}

/* --- searchable dropdowns (type-to-filter) --- */
function fillSelect(selectEl, bats, keepValue){
  const current = keepValue ?? selectEl.value;
  selectEl.innerHTML = "";
  bats.forEach(name=>{
    const o=document.createElement("option");
    o.value=name; o.textContent=name;
    selectEl.appendChild(o);
  });
  // restore if possible
  if(current && bats.includes(current)) selectEl.value = current;
  else if(bats.length) selectEl.value = bats[0];
}

function applyFilter(which){
  const q = (which === "A" ? $("searchA").value : $("searchB").value).trim().toLowerCase();
  const sel = which === "A" ? $("batA") : $("batB");
  const filtered = q ? ALL_BATS.filter(n => n.toLowerCase().includes(q)) : ALL_BATS.slice();
  fillSelect(sel, filtered, sel.value);
}

/* --- main calc --- */
function calc(){
  const batA = $("batA").value;
  const batB = $("batB").value;
  const metric = $("metric").value;
  const alpha = clamp(Number($("alpha").value || 0.67), 0, 1);
  $("alpha").value = alpha.toFixed(2);

  const bowlTypes = RUN.bowl_types;

  const cw = currentWeights(bowlTypes);
  $("weightSum").textContent = `sum: ${fmt(cw.sum, 3)}`;

  if($("weightPreset").value === "custom"){
    renderWeightsEditor(bowlTypes);
  } else {
    $("weightsBox").style.display = "none";
  }

  $("nameA").textContent = batA;
  $("nameB").textContent = batB;
  $("nameP").textContent = `${batA} + ${batB}`;
  $("pairTitle").textContent = `${batA} + ${batB}`;

  const metricLabel = (metric === "run") ? "Run impact" : (metric === "wicket") ? "Wicket impact" : "Total impact";
  $("metaRight").textContent = `${metricLabel} · alpha=${alpha.toFixed(2)} · weights=${$("weightPreset").value}`;
  $("metaA").textContent = metricLabel;
  $("metaB").textContent = metricLabel;
  $("metaP").textContent = metricLabel;

  renderBatterTiles("tilesA", batA, metric);
  renderBatterTiles("tilesB", batB, metric);
  renderPartnershipTiles("tilesP", batA, batB, metric, alpha);

  const finalGz = computeFinalWeightedGoodZ(batA, batB, metric, alpha, cw.w);
  $("finalScore").textContent = fmt(finalGz, 2);

  // final box heat based on goodness z
  $("finalBox").style.setProperty("--heat", heatFromGoodZ(finalGz));
  $("finalLabel").textContent = `Final score (weighted z) · ${metricLabel}`;
  $("finalSub").textContent = "Σ w × z (direction-adjusted) / Σ w";

  setStatus("Calculated.", "ok");
}

function populateInitialDropdowns(bats){
  ALL_BATS = bats.slice();
  fillSelect($("batA"), bats, null);
  fillSelect($("batB"), bats, null);
  if(bats.length >= 2){
    $("batA").value = bats[0];
    $("batB").value = bats[1];
  }
}

async function init(){
  try{
    setStatus("Loading data…");

    RUN = await loadJSON("run_pivot.json");
    WK  = await loadJSON("wicket_pivot.json");
    try{ BALLS = await loadJSON("balls_pivot.json"); }catch(e){ BALLS=null; }
    BASE = await loadJSON("baseline.json");
    FILE_WEIGHTS = await loadJSON("weights.json");

    if(!RUN?.bats?.length) throw new Error("run_pivot.json missing bats[]");
    if(!RUN?.bowl_types?.length) throw new Error("run_pivot.json missing bowl_types[]");

    populateInitialDropdowns(RUN.bats);

    $("calcBtn").addEventListener("click", calc);
    ["batA","batB","metric","alpha","weightPreset","normalizeWeights"].forEach(id=>{
      $(id).addEventListener("change", ()=>calc());
    });
    $("copyWeights").addEventListener("click", copyWeightsJSON);
    $("resetWeights").addEventListener("click", resetWeightsToFile);

    $("searchA").addEventListener("input", ()=>{
      applyFilter("A");
      // keep selection stable; only recalc when selection changes
    });
    $("searchB").addEventListener("input", ()=>{
      applyFilter("B");
    });

    // recalc when a filtered select changes
    $("batA").addEventListener("change", ()=>calc());
    $("batB").addEventListener("change", ()=>calc());

    // If user has saved weights, flip to custom automatically
    try{
      const saved = localStorage.getItem("pm_custom_weights");
      if(saved){
        customWeights = JSON.parse(saved);
        $("weightPreset").value = "custom";
      }
    }catch(e){}

    setStatus(`Loaded ${RUN.bats.length} batters · ${RUN.bowl_types.length} bowl types.`, "ok");
    calc();
  }catch(err){
    console.error(err);
    setStatus(`Error: ${err.message}. Make sure index.html + JSON files are in the SAME folder.`, "err");
    $("calcBtn").disabled = true;
  }
}

init();
</script>
</body>
</html>
