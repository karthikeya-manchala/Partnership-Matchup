<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Partnership Matchup Ratings</title>
  <style>
    :root{
      --bg:#f6f3ed;
      --card:#ffffff;
      --text:#17202a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(16,24,40,0.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 50% -200px, #ffffff 0%, var(--bg) 70%);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px;}
    .header{text-align:center;margin-bottom:16px;}
    .header h1{margin:0;font-size:30px;letter-spacing:-0.02em}
    .header .sub{margin-top:6px;color:var(--muted);font-size:14px}

    .layout{
      display:grid;
      grid-template-columns: 460px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .layout{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .left{padding:16px;}
    .right{padding:14px;}

    .sectionTitle{
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--muted);
      margin:14px 0 8px;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row1{display:grid;grid-template-columns:1fr;gap:10px}
    label{display:block;color:var(--muted);font-size:13px;margin:0 0 6px}
    input, select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{box-shadow:0 0 0 3px rgba(59,130,246,0.15);border-color:#cbd5e1}

    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .btn{
      width:100%;
      background:#111827;
      color:#fff;
      border:none;
      border-radius:14px;
      padding:11px 12px;
      font-weight:650;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      background:#fff;
    }
    .inline{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:8px;
    }

    .calcOk{
      color:#065f46;
      font-weight:700;
      margin-top:10px;
    }

    table{width:100%;border-collapse:separate;border-spacing:0}
    th, td{padding:10px 10px;border-top:1px solid var(--border);font-size:13px}
    th{color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;font-size:11px}
    tr:first-child th, tr:first-child td{border-top:none}
    td:last-child{text-align:right}
    .wInput{
      width:92px;
      text-align:right;
      padding:8px 10px;
      border-radius:12px;
    }
    .actions{display:grid;gap:10px;margin-top:12px}
    .btn2{
      width:100%;
      background:#fff;
      color:#111827;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      font-weight:650;
      cursor:pointer;
    }

    /* RIGHT SIDE */
    .rightTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 6px 12px;
    }
    .rightTop .title{
      font-size:18px;
      font-weight:800;
      letter-spacing:-0.01em;
    }
    .rightTop .meta{
      color:var(--muted);
      font-size:13px;
      text-align:right;
    }

    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 800px){ .twoCols{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
      background:#fff;
    }
    .panelHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:4px 4px 10px;
    }
    .panelHeader .name{font-weight:800}
    .panelHeader .small{color:var(--muted);font-size:13px}

    .tiles{display:grid;gap:10px}
    .tile{
      position:relative;
      border-radius:16px;
      padding:12px 12px 10px;
      overflow:hidden;
      min-height:92px;
      border:1px solid rgba(0,0,0,0.08);
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }
    .tile::before{
      content:"";
      position:absolute;
      inset:-40px -40px auto auto;
      width:180px;height:180px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.45), rgba(255,255,255,0) 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .tileTop{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .tileType{
      font-weight:900;
      letter-spacing:0.02em;
      color:rgba(17,24,39,0.75);
    }
    .tileTag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,0.18);
      color:rgba(17,24,39,0.8);
      background: rgba(255,255,255,0.25);
    }
    .tileVal{
      margin-top:6px;
      font-size:34px;
      font-weight:900;
      letter-spacing:-0.02em;
      color:rgba(17,24,39,0.7);
    }
    .tileSub{
      margin-top:2px;
      font-size:12px;
      color:rgba(17,24,39,0.65);
    }

    .pairPanel{margin-top:12px}
    .pairHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:4px 4px 10px;
      font-weight:800;
    }
    .pairTiles{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 1000px){ .pairTiles{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .pairTiles{grid-template-columns: 1fr;} }

    .finalRow{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:12px;
      margin-top:12px;
      align-items:stretch;
    }
    @media (max-width: 900px){ .finalRow{grid-template-columns:1fr} }
    .finalBox{
      border-radius:16px;
      padding:14px;
      border:1px solid rgba(0,0,0,0.08);
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
      position:relative;
      overflow:hidden;
      min-height:130px;
    }
    .finalBox .kicker{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:rgba(17,24,39,0.75);
      margin-bottom:10px;
    }
    .finalBox .big{
      font-size:46px;
      font-weight:950;
      letter-spacing:-0.03em;
      color:rgba(17,24,39,0.72);
      line-height:1;
    }
    .finalBox .formula{
      margin-top:10px;
      color:rgba(17,24,39,0.65);
      font-size:12px;
    }
    .finalBlank{
      border:1px dashed rgba(0,0,0,0.15);
      border-radius:16px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:13px;
    }

    /* Toggle */
    .checkRow{display:flex;align-items:center;gap:10px;margin-top:10px;color:var(--muted);font-size:13px}
    .checkRow input{width:auto}

    .codePills{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .miniPill{
      display:inline-flex;
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Partnership Matchup Ratings</h1>
      <div class="sub">Choose a metric → see scores by bowl type (values loaded from 0–1 pivots and multiplied by 100).</div>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <div class="card left">
        <div class="row2">
          <div>
            <label>Search Batter 1</label>
            <input id="searchA" placeholder="Type to filter Batter 1…" />
            <div class="hint">Dropdown updates as you type.</div>
          </div>
          <div>
            <label>Search Batter 2</label>
            <input id="searchB" placeholder="Type to filter Batter 2…" />
            <div class="hint">Dropdown updates as you type.</div>
          </div>
        </div>

        <div class="row2" style="margin-top:10px;">
          <div>
            <label>Batter 1</label>
            <select id="batterA"></select>
          </div>
          <div>
            <label>Batter 2</label>
            <select id="batterB"></select>
          </div>
        </div>

        <div class="row2" style="margin-top:10px;">
          <div>
            <label>Metric</label>
            <select id="metric">
              <option value="total">Total impact</option>
              <option value="run">Run impact</option>
              <option value="wicket">Wicket impact</option>
            </select>
          </div>
          <div>
            <label>alpha</label>
            <input id="alpha" type="number" min="0" max="1" step="0.01" value="0.67" />
          </div>
        </div>

        <div class="row2" style="margin-top:10px;">
          <div>
            <label>Weights</label>
            <select id="weightMode">
              <option value="equal">Equal</option>
              <option value="custom" selected>Custom (edit below)</option>
            </select>
          </div>
          <div style="display:flex;align-items:end">
            <button class="btn" id="recalc">Recalculate</button>
          </div>
        </div>

        <div class="checkRow">
          <input id="normalize" type="checkbox" checked />
          <div>Normalize custom weights to sum = 1</div>
          <div class="pill" id="wSumPill" style="margin-left:auto;">sum: 1.000</div>
        </div>

        <div class="calcOk" id="calcStatus">Calculated.</div>

        <div class="sectionTitle">Weights table</div>
        <div class="card" style="box-shadow:none;border-radius:16px;padding:0;overflow:hidden">
          <table>
            <thead>
              <tr>
                <th style="width:50%">Bowl type</th>
                <th style="width:50%;text-align:right">Weight</th>
              </tr>
            </thead>
            <tbody id="weightsBody"></tbody>
          </table>
        </div>

        <div class="actions">
          <button class="btn2" id="copyWeights">Copy weights JSON</button>
          <button class="btn2" id="resetWeights">Reset to file / defaults</button>
        </div>

        <div class="codePills">
          <div class="miniPill">run_pair = α·max(A_run,B_run) + (1−α)·min(A_run,B_run)</div>
          <div class="miniPill">wicket_pair = α·min(A_wk,B_wk) + (1−α)·max(A_wk,B_wk)</div>
          <div class="miniPill">total_pair = (run_pair + wicket_pair)/2</div>
        </div>

        <div class="hint" style="margin-top:10px;">
          Tile colors use <b>red → white → green</b> on the displayed score (0–100; white at 50).
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card right">
        <div class="rightTop">
          <div class="title">Scores by bowl type</div>
          <div class="meta" id="metaLine">Total impact · alpha=0.67 · weights=custom</div>
        </div>

        <div class="twoCols">
          <div class="panel">
            <div class="panelHeader">
              <div class="name" id="nameA">—</div>
              <div class="small">Total impact</div>
            </div>
            <div class="tiles" id="tilesA"></div>
          </div>

          <div class="panel">
            <div class="panelHeader">
              <div class="name" id="nameB">—</div>
              <div class="small">Total impact</div>
            </div>
            <div class="tiles" id="tilesB"></div>
          </div>
        </div>

        <div class="panel pairPanel" style="margin-top:12px;">
          <div class="pairHeader">
            <div id="pairTitle">—</div>
            <div style="color:var(--muted);font-size:13px" id="pairMetricLabel">Total impact</div>
          </div>
          <div class="pairTiles" id="pairTiles"></div>
        </div>

        <div class="finalRow">
          <div class="finalBox" id="finalBox">
            <div class="kicker" id="finalKicker">FINAL SCORE (WEIGHTED) · TOTAL IMPACT</div>
            <div class="big" id="finalScore">—</div>
            <div class="formula" id="finalFormula">Σ w×score / Σ w</div>
          </div>
          <div class="finalBlank" id="finalBlank">Andre Fletcher + Jos Buttler</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // -----------------------
  // FILES (0–1 values)
  // -----------------------
  const RUN_URL = "run_pivot.json";
  const WICKET_URL = "wicket_pivot.json";

  // -----------------------
  // STATE
  // -----------------------
  let runData = null;     // { bats:[], bowl_types:[], values:{batter:{type:val0to1}} }
  let wicketData = null;  // same
  let bats = [];
  let bowlTypes = [];
  let weights = {};       // { type: weight }
  let defaultWeights = {}; // for reset

  // -----------------------
  // DOM
  // -----------------------
  const elSearchA = document.getElementById("searchA");
  const elSearchB = document.getElementById("searchB");
  const elA = document.getElementById("batterA");
  const elB = document.getElementById("batterB");
  const elMetric = document.getElementById("metric");
  const elAlpha = document.getElementById("alpha");
  const elWeightMode = document.getElementById("weightMode");
  const elNormalize = document.getElementById("normalize");
  const elWSumPill = document.getElementById("wSumPill");
  const elWeightsBody = document.getElementById("weightsBody");
  const elMetaLine = document.getElementById("metaLine");

  const elNameA = document.getElementById("nameA");
  const elNameB = document.getElementById("nameB");
  const tilesA = document.getElementById("tilesA");
  const tilesB = document.getElementById("tilesB");
  const pairTiles = document.getElementById("pairTiles");

  const elPairTitle = document.getElementById("pairTitle");
  const elPairMetricLabel = document.getElementById("pairMetricLabel");

  const elFinalBox = document.getElementById("finalBox");
  const elFinalScore = document.getElementById("finalScore");
  const elFinalKicker = document.getElementById("finalKicker");
  const elFinalBlank = document.getElementById("finalBlank");

  const elCalcStatus = document.getElementById("calcStatus");

  document.getElementById("recalc").addEventListener("click", recalcAll);
  document.getElementById("copyWeights").addEventListener("click", copyWeightsJSON);
  document.getElementById("resetWeights").addEventListener("click", resetWeights);

  elMetric.addEventListener("change", recalcAll);
  elAlpha.addEventListener("input", () => {
    elMetaLine.textContent = `${metricLabel()} · alpha=${fmtAlpha()} · weights=${weightsLabel()}`;
  });
  elAlpha.addEventListener("change", recalcAll);

  elWeightMode.addEventListener("change", () => {
    if (elWeightMode.value === "equal") {
      setEqualWeights();
    }
    recalcAll();
  });
  elNormalize.addEventListener("change", () => {
    if (elNormalize.checked) normalizeWeights();
    renderWeightsTable();
    recalcAll();
  });

  elA.addEventListener("change", recalcAll);
  elB.addEventListener("change", recalcAll);

  elSearchA.addEventListener("input", () => filterDropdown(elA, elSearchA.value));
  elSearchB.addEventListener("input", () => filterDropdown(elB, elSearchB.value));

  // -----------------------
  // UTIL
  // -----------------------
  function isObject(x){ return x && typeof x === "object" && !Array.isArray(x); }
  function toNum(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }
  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

  function fmt(n){
    if (n === null || n === undefined || !Number.isFinite(n)) return "—";
    return (Math.abs(n - Math.round(n)) < 1e-9) ? String(Math.round(n)) : n.toFixed(1);
  }
  function fmtAlpha(){
    const a = clamp(toNum(elAlpha.value) ?? 0.67, 0, 1);
    return a.toFixed(2);
  }
  function metricLabel(){
    const m = elMetric.value;
    return m === "run" ? "Run impact" : m === "wicket" ? "Wicket impact" : "Total impact";
  }
  function weightsLabel(){
    return elWeightMode.value === "equal" ? "equal" : "custom";
  }

  // Red → White → Green at 50 (score 0–100)
  function redWhiteGreen(score){
    const s = clamp(toNum(score) ?? 0, 0, 100);
    const red   = [217, 83,  79];
    const white = [255, 255, 255];
    const green = [ 76, 175,  80];

    const lerp = (a,b,t)=>a+(b-a)*t;
    const mix = (c1,c2,t)=>[
      Math.round(lerp(c1[0],c2[0],t)),
      Math.round(lerp(c1[1],c2[1],t)),
      Math.round(lerp(c1[2],c2[2],t)),
    ];
    const rgb = (s <= 50) ? mix(red, white, s/50) : mix(white, green, (s-50)/50);
    return `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
  }

  // -----------------------
  // DATA ACCESS (0–1 -> *100)
  // -----------------------
  function getRun100(batter, type){
    const v = runData?.values?.[batter]?.[type];
    const n = toNum(v);
    return n === null ? null : clamp(n * 100, 0, 100);
  }
  function getWicket100(batter, type){
    const v = wicketData?.values?.[batter]?.[type];
    const n = toNum(v);
    return n === null ? null : clamp(n * 100, 0, 100);
  }
  function getTotal100(batter, type){
    const r = getRun100(batter, type);
    const w = getWicket100(batter, type);
    if (r === null && w === null) return null;
    if (r === null) return w;
    if (w === null) return r;
    return (r + w) / 2;
  }
  function getMetric100(batter, type, metric){
    if (metric === "run") return getRun100(batter, type);
    if (metric === "wicket") return getWicket100(batter, type);
    return getTotal100(batter, type);
  }

  // Pair logic (uses run/wicket even if metric is total)
  function pairRun100(a, b, type, alpha){
    const ar = getRun100(a, type), br = getRun100(b, type);
    if (ar === null && br === null) return null;
    if (ar === null) return br;
    if (br === null) return ar;
    const mx = Math.max(ar, br), mn = Math.min(ar, br);
    return alpha*mx + (1-alpha)*mn;
  }
  function pairWicket100(a, b, type, alpha){
    const aw = getWicket100(a, type), bw = getWicket100(b, type);
    if (aw === null && bw === null) return null;
    if (aw === null) return bw;
    if (bw === null) return aw;
    const mx = Math.max(aw, bw), mn = Math.min(aw, bw);
    // per your screenshot: α*min + (1-α)*max
    return alpha*mn + (1-alpha)*mx;
  }
  function pairTotal100(a, b, type, alpha){
    const pr = pairRun100(a,b,type,alpha);
    const pw = pairWicket100(a,b,type,alpha);
    if (pr === null && pw === null) return null;
    if (pr === null) return pw;
    if (pw === null) return pr;
    return (pr + pw) / 2;
  }
  function pairMetric100(a, b, type, alpha, metric){
    if (metric === "run") return pairRun100(a,b,type,alpha);
    if (metric === "wicket") return pairWicket100(a,b,type,alpha);
    return pairTotal100(a,b,type,alpha);
  }

  // -----------------------
  // WEIGHTS
  // -----------------------
  function setEqualWeights(){
    const w = {};
    const v = bowlTypes.length ? 1 / bowlTypes.length : 1;
    for (const t of bowlTypes) w[t] = v;
    weights = w;
    renderWeightsTable();
  }

  function normalizeWeights(){
    let s = 0;
    for (const t of bowlTypes) s += (toNum(weights[t]) ?? 0);
    if (s <= 0) {
      setEqualWeights();
      return;
    }
    for (const t of bowlTypes) weights[t] = (toNum(weights[t]) ?? 0) / s;
  }

  function weightsSum(){
    let s=0;
    for (const t of bowlTypes) s += (toNum(weights[t]) ?? 0);
    return s;
  }

  function renderWeightsTable(){
    elWeightsBody.innerHTML = "";
    for (const t of bowlTypes){
      const tr = document.createElement("tr");

      const td1 = document.createElement("td");
      td1.textContent = t;

      const td2 = document.createElement("td");
      const inp = document.createElement("input");
      inp.className = "wInput";
      inp.type = "number";
      inp.step = "0.01";
      inp.min = "0";
      inp.value = (toNum(weights[t]) ?? 0).toFixed(2).replace(/\.00$/,".0").replace(/(\.\d)0$/,"$1");
      inp.disabled = (elWeightMode.value !== "custom");

      inp.addEventListener("input", () => {
        weights[t] = clamp(toNum(inp.value) ?? 0, 0, 1e9);
        if (elNormalize.checked) normalizeWeights();
        elWSumPill.textContent = `sum: ${weightsSum().toFixed(3)}`;
      });
      inp.addEventListener("change", () => {
        if (elNormalize.checked) normalizeWeights();
        renderWeightsTable();
        recalcAll();
      });

      td2.appendChild(inp);
      tr.appendChild(td1);
      tr.appendChild(td2);
      elWeightsBody.appendChild(tr);
    }
    elWSumPill.textContent = `sum: ${weightsSum().toFixed(3)}`;
  }

  function resetWeights(){
    // if you had file-defined weights, you could load them here.
    // for now: equal weights as a clean reset, and switch to custom.
    elWeightMode.value = "custom";
    setEqualWeights();
    elNormalize.checked = true;
    normalizeWeights();
    renderWeightsTable();
    recalcAll();
  }

  async function copyWeightsJSON(){
    const obj = {};
    for (const t of bowlTypes) obj[t] = +(toNum(weights[t]) ?? 0).toFixed(6);
    const txt = JSON.stringify(obj, null, 2);
    try{
      await navigator.clipboard.writeText(txt);
      elCalcStatus.textContent = "Copied weights JSON to clipboard.";
      setTimeout(()=> elCalcStatus.textContent = "Calculated.", 1400);
    }catch{
      // fallback
      prompt("Copy weights JSON:", txt);
    }
  }

  // -----------------------
  // DROPDOWNS + FILTERING
  // -----------------------
  function populateSelect(sel, items){
    const prev = sel.value;
    sel.innerHTML = "";
    for (const x of items){
      const opt = document.createElement("option");
      opt.value = x;
      opt.textContent = x;
      sel.appendChild(opt);
    }
    if (items.includes(prev)) sel.value = prev;
  }

  function filterDropdown(sel, q){
    const query = (q || "").trim().toLowerCase();
    const filtered = query ? bats.filter(b => b.toLowerCase().includes(query)) : bats;
    populateSelect(sel, filtered);
    // keep selections stable if possible
    if (!sel.value && filtered.length) sel.value = filtered[0];
    recalcAll();
  }

  // -----------------------
  // RENDER TILES
  // -----------------------
  function tileHTML(type, value, tagText){
    const bg = redWhiteGreen(value ?? 0);
    return `
      <div class="tile" style="background:${bg}">
        <div class="tileTop">
          <div class="tileType">${type}</div>
          <div class="tileTag">${tagText}</div>
        </div>
        <div class="tileVal">${value === null ? "N/A" : fmt(value)}</div>
        <div class="tileSub">${metricLabel().toLowerCase()}</div>
      </div>
    `;
  }

  function renderBatterTiles(container, batter){
    const tag = "TOTAL";
    container.innerHTML = bowlTypes.map(t => {
      const v = getMetric100(batter, t, elMetric.value);
      return tileHTML(t, v, tag);
    }).join("");
  }

  function renderPairTiles(container, a, b, alpha){
    const tag = "TOTAL";
    container.innerHTML = bowlTypes.map(t => {
      const v = pairMetric100(a, b, t, alpha, elMetric.value);
      return tileHTML(t, v, tag);
    }).join("");
  }

  function weightedFinalScore(a, b, alpha){
    let num = 0;
    let den = 0;
    for (const t of bowlTypes){
      const w = toNum(weights[t]) ?? 0;
      if (w <= 0) continue;
      const v = pairMetric100(a, b, t, alpha, elMetric.value);
      if (v === null) continue;
      num += w * v;
      den += w;
    }
    if (den <= 0) return null;
    return num / den;
  }

  function recalcAll(){
    if (!runData || !wicketData) return;

    const a = elA.value;
    const b = elB.value;
    const alpha = clamp(toNum(elAlpha.value) ?? 0.67, 0, 1);

    elNameA.textContent = a || "—";
    elNameB.textContent = b || "—";

    const metricText = metricLabel();
    elMetaLine.textContent = `${metricText} · alpha=${alpha.toFixed(2)} · weights=${weightsLabel()}`;
    elPairMetricLabel.textContent = metricText;

    document.querySelectorAll(".panelHeader .small").forEach(el => el.textContent = metricText);

    elPairTitle.textContent = (a && b) ? `${a} + ${b}` : "—";
    elFinalBlank.textContent = (a && b) ? `${a} + ${b}` : "—";

    renderBatterTiles(tilesA, a);
    renderBatterTiles(tilesB, b);
    renderPairTiles(pairTiles, a, b, alpha);

    const final = weightedFinalScore(a, b, alpha);
    elFinalKicker.textContent = `FINAL SCORE (WEIGHTED) · ${metricText.toUpperCase()}`;
    elFinalScore.textContent = final === null ? "—" : fmt(final);

    // color final box too
    const bg = redWhiteGreen(final ?? 0);
    elFinalBox.style.background = bg;
  }

  // -----------------------
  // LOAD JSON
  // -----------------------
  async function loadJSON(url){
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error(`Failed to load ${url} (${res.status})`);
    return await res.json();
  }

  async function init(){
    try{
      [runData, wicketData] = await Promise.all([loadJSON(RUN_URL), loadJSON(WICKET_URL)]);

      // schema: bats, bowl_types, values
      bats = Array.isArray(runData?.bats) ? runData.bats.slice() : [];
      const bats2 = Array.isArray(wicketData?.bats) ? wicketData.bats.slice() : [];
      bats = Array.from(new Set([...bats, ...bats2])).filter(Boolean).sort((x,y)=>String(x).localeCompare(String(y)));

      bowlTypes = Array.isArray(runData?.bowl_types) ? runData.bowl_types.slice() : [];
      const bt2 = Array.isArray(wicketData?.bowl_types) ? wicketData.bowl_types.slice() : [];
      bowlTypes = Array.from(new Set([...bowlTypes, ...bt2])).filter(Boolean);

      // initialize weights: equal, then switch to custom to match your screenshot default
      setEqualWeights();
      defaultWeights = JSON.parse(JSON.stringify(weights));
      elWeightMode.value = "custom";
      elNormalize.checked = true;
      normalizeWeights();
      renderWeightsTable();

      populateSelect(elA, bats);
      populateSelect(elB, bats);

      // defaults
      if (bats.length){
        elA.value = bats[0];
        elB.value = bats.length > 1 ? bats[1] : bats[0];
      }

      recalcAll();
      elCalcStatus.textContent = "Calculated.";
    }catch(e){
      console.error(e);
      elCalcStatus.textContent = `Error: ${e.message}`;
      tilesA.innerHTML = `<div class="hint">${e.message}</div>`;
      tilesB.innerHTML = `<div class="hint">Check file paths and JSON schema.</div>`;
    }
  }

  init();
</script>
</body>
</html>
